#!/usr/bin/sh php
<?php

require __DIR__ . '/../vendor/autoload.php';
Nette\Diagnostics\Debugger::enable(FALSE);

set_error_handler(function ($severenity, $message) {
	throw new RuntimeException($message);
});

/**
 * This script generates Kdyby\Money\CurrencyTable from data provided by ISO 4217 Maintenance Agency
 * Note: Countries without universal currency, funds, testing values and metals are not added to table.
 */

$contents = file_get_contents('http://www.currency-iso.org/dam/downloads/table_a1.xml');
$xml = simplexml_load_string($contents);

$currencies = array();
foreach ($xml->CcyTbl->children() as $entry) {
	if (isset($entry['isFund'])) { // skip funds
		continue;
	}

    if (substr((string)$entry->CtryNm, 0, 2) == 'ZZ') { // skip testing and metals
        continue;
    }

    if ((string)$entry->CcyNm === 'No universal currency') { // skip countries without universal currency
        continue;
    }

	if (!isset($currencies[$code = (string) $entry->Ccy])) {
		$currencies[$code] = array(
			'code' => $code,
			'name' => (string) $entry->CcyNm,
			'number' => (string)  $entry->CcyNbr,
			'subunits_in_unit' => pow(10, (int) $entry->CcyMnrUnts),
			'countries' => [ (string) $entry->CtryNm ],
		);

	} else {
		$currencies[$code]['countries'][] = (string) $entry->CtryNm;
	}
}

ksort($currencies);

$pdo = new \Nette\Database\Connection('mysql:host=127.0.0.1;dbname=information_schema', 'root', 'heslo');
$delimite = function ($id) use ($pdo) {
	return $pdo->getSupplementalDriver()->delimite($id);
};

fwrite($sqlDump = fopen(__DIR__ . '/../data/currencies.sql', 'w'), "\n");
fwrite($sqlDump, '-- this file was generated by Kdyby/Money at ' . date('Y-m-d H:i:s') . "\n");
fwrite($sqlDump, '-- @see https://github.com/Kdyby/Money/blob/master/bin/generate-currency-table.php' . "\n");

$tableName = $delimite('currencies');
fwrite($sqlDump, "
SET NAMES utf8;
SET foreign_key_checks = 0;

CREATE TABLE IF NOT EXISTS $tableName (
  `code` VARCHAR(15) NOT NULL,
  `name` VARCHAR(100) NOT NULL,
  `number` CHAR(5) NOT NULL,
  `subunits_in_unit` INT NOT NULL,
  `countries` LONGTEXT NOT NULL COMMENT '(DC2Type:json_array)',
  PRIMARY KEY (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

");


$columns = array_map(array($pdo->getSupplementalDriver(), 'delimite'), array_keys(reset($currencies)));
fwrite($sqlDump, "INSERT INTO $tableName (" . implode(', ', $columns) . ") VALUES\n");

$i = count($currencies);
foreach ($currencies as $currency) {
	$currency['countries'] = json_encode($currency['countries']);
	$values = array_map(function ($value) use ($pdo) {
		return is_integer($value) ? (int) $value : $pdo->quote($value);
	}, $currency);
	fwrite($sqlDump, "(" . implode(', ', $values) . ")" . (--$i > 0 ? ',' : '') . "\n");
}

fwrite($sqlDump, "ON DUPLICATE KEY UPDATE " . implode(', ', array_map(function ($column) use ($delimite) {
		return $delimite($column) . ' = VALUES(' . $delimite($column) . ')';
	}, array_keys(reset($currencies)))) . ";\n");

fclose($sqlDump);
